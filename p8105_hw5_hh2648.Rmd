---
title: "P8105 Data Science I - Homework 6"
author: "Heng Hu (hh2648)"
date: 2025-11-26
output: github_document
---

```{r, message = FALSE}
# Setup
library(tidyverse)
set.seed(2648)
```


## Problem 1

```{r, message=FALSE, warning=FALSE}

# Read and tidy the data
homicides = read_csv(file = "./data/homicide-data.csv") |> 
   mutate(state = toupper(state),
          city_state = str_c(city, ", ", state),
          reported_date = case_match(reported_date,
                                     201511018 ~ 20151018,
                                     201511105 ~ 20151105,
                                     .default = reported_date),
          reported_date = ymd(reported_date),
          victim_race = as.factor(victim_race),
          victim_age = as.numeric(victim_age),
          victim_sex = as.factor(victim_sex),
          disposition = as.factor(disposition),
          resolved = ifelse(disposition %in% c("Open/No arrest", "Closed without arrest"), FALSE, TRUE)) |> 
  filter(!city_state %in% c("Dallas, TX", " Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
         victim_race %in% c("White", "Black"))

# Use the glm function to fit a logistic regression in Baltimore
baltimore_glm = homicides |> 
  filter(city_state == "Baltimore, MD") |> 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = _, family = binomial())

baltimore_glm |> 
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |> 
  select(term, OR = estimate, conf.low, conf.high) |> 
  filter(term == "victim_sexMale") |> 
  knitr::kable()

# Apply to all the cities
all_est = homicides |> 
  nest(.by = city_state) |> 
  mutate(model = map(data, \(df) glm(resolved ~ victim_age + victim_race + victim_sex, data = df, family = binomial())),
         result = map(model, broom::tidy, exponentiate = TRUE, conf.int = TRUE)) |>
  unnest(cols = result) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, term, OR = estimate, ci_lower = conf.low, ci_upper = conf.high)

# Make a plot
all_est |> 
  ggplot(aes(x = OR, y = fct_reorder(city_state, OR))) +
  geom_point() +
  geom_errorbar(aes(xmin = ci_lower, xmax = ci_upper), width = 0.6) +
  geom_vline(xintercept = 1, color = "red") +
  labs(title = "Adjusted Odds Ratios by City",
       x = "Odds Ratio",
       y = "City") +
  theme_minimal()

```

The plot indicates 


## Problem 2

```{r}

# Read and tidy the data
library(p8105.datasets)
data("weather_df")

# Apply boostrap to calculate r squared and beta ratio
weather = weather_df |> 
  modelr::bootstrap(n = 5000) |> 
  mutate(model = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
         result_1 = map(model, broom::glance),
         result_2 = map(model, broom::tidy)) |>
  unnest(cols = c(result_1, result_2), names_sep = "_") |> 
  select(.id, r_squared = result_1_r.squared, covar = result_2_term, est = result_2_estimate) |> 
  filter(covar != "(Intercept)") |> 
  pivot_wider(names_from = covar, values_from = est) |> 
  mutate(beta_ratio = tmin / prcp) |> 
  select(-tmin, -prcp) |> 
  pivot_longer(cols = c(r_squared, beta_ratio), 
               names_to = "term", values_to = "est")

# Make a plot to see the distribution of the two quantities
weather |> 
  ggplot(aes(x = est)) +
  geom_density() +
  facet_wrap(~ term, scales = "free")

# Get 95% CI for the two quantities
weather |> 
  group_by(term) |> 
  summarise(ci_lower = quantile(est, 0.025),
            ci_upper = quantile(est, 0.975)) |> 
  mutate(across(c(ci_lower, ci_upper), ~ formatC(signif(.x, 4), width = 4))) |>
  knitr::kable(col.names = c("Term", "95% CI Lower", "95% CI Upper"))

```

The plot indicates 


## Problem 3
